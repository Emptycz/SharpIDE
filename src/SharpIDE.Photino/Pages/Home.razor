@page "/"
@using Microsoft.Build.Construction
@using Microsoft.Build.Evaluation
@using Microsoft.Build.Execution
@using Microsoft.Build.Globbing
@using Microsoft.Build.Globbing.Extensions
@using SharpIDE.Application.Features.SolutionDiscovery

<MudText>Welcome to a new Photino Blazor app!</MudText>

@if (_solutionFile is null)
{
	return;
}

<MudTreeView T="ProjectInSolution">
	@foreach(var project in _rootNodes)
	{
		@GetProjectFragment(project)
	}
</MudTreeView>


@code {

	private SolutionFile _solutionFile = null!;
	private List<ProjectInSolution> _rootNodes = [];
	private Dictionary<string, List<Folder>> _folders = new();

	private RenderFragment GetProjectFragment(ProjectInSolution project) =>
		@<text>
			 <MudTreeViewItem Value="project" Text="@project.ProjectName">
				 @foreach(var child in _solutionFile.ProjectsByGuid.Values.Where(s => s.ParentProjectGuid == project.ProjectGuid).OrderBy(s => s.ProjectName))
				 {
					 @GetProjectFragment(child)
				 }
				 @GetFolderFragment(project)
			 </MudTreeViewItem>
		 </text>;

	private RenderFragment GetFolderFragment(ProjectInSolution project) =>
		@<text>
			 @foreach (var folder in _folders.GetValueOrDefault(project.ProjectGuid, []))
			 {
				 <MudTreeViewItem Value="folder" Text="@folder.Name">
				 </MudTreeViewItem>
			 }
		 </text>;

	protected override async Task OnInitializedAsync()
	{
		var solutionFile = GetNodesInSolution.ParseSolutionFileFromPath("D:/matth/Documents/Git/amazon/ClientPortal.sln");
		ArgumentNullException.ThrowIfNull(solutionFile);
		_solutionFile = solutionFile;
		var rootNodes = solutionFile.ProjectsByGuid.Values.Where(p => p.ParentProjectGuid == null).OrderBy(s => s.ProjectName).ToList();
		_rootNodes = rootNodes;


	}

}
